{% extends 'front/master.html' %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4 text-center">Checkout</h2>
    <div class="row">
        <!-- LEFT: Shipping Info -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white">
                    Shipping Address
                </div>
                <div class="card-body">
                    <form id="checkoutForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="firstName">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="first_name" placeholder="John" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="lastName">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="last_name" placeholder="Doe" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputAddress">Address</label>
                            <input type="text" class="form-control" id="inputAddress" name="address" placeholder="1234 Main St" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="inputCity">City</label>
                                <input type="text" class="form-control" id="inputCity" name="city" placeholder="Phnom Penh" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="inputCountry">Country</label>
                                <select id="inputCountry" class="form-control" name="country" required>
                                    <option selected disabled>Choose...</option>
                                    <option>Cambodia</option>
                                    <option>Vietnam</option>
                                    <option>Laos</option>
                                </select>
                            </div>
                            <div class="form-group col-md-2">
                                <label for="inputZip">Zip</label>
                                <input type="text" class="form-control" id="inputZip" name="zip" placeholder="12000" required>
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="inputEmail">Email</label>
                            <input type="email" class="form-control" id="inputEmail" name="email" placeholder="example@email.com" required>
                        </div>
                        <div class="form-group">
                            <label for="inputPhone">Phone Number</label>
                            <input type="text" class="form-control" id="inputPhone" name="phone" placeholder="+855 12 345 678" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT: Order Summary -->
        <div class="col-lg-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    Order Summary
                </div>
                <div class="card-body">
                    <ul id="cart_list_tbody" class="list-group mb-3">

                    </ul>
                    <h5 class="d-flex justify-content-between">
                        <span>Total (USD)</span>
                        <span id="label_total_usd" class="text-success">$0.00</span>
                    </h5>
                    <h5 class="d-flex justify-content-between">
                        <span>Total (KHR)</span>
                        <span id="label_total_khr" class="text-success">áŸ›0.00</span>
                    </h5>

                    <button class="btn btn-warning btn-block btn-lg mt-3" type="submit" form="checkoutForm">
                        Place Order <i class="fa fa-check"></i>
                    </button>

                    <p class="mt-3 text-center text-muted" style="font-size: 0.95rem;">
                        By placing your order, you agree to our
                        <a href="#" class="text-warning">Terms & Conditions</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById("checkoutForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;
        const data = {
            firstName: form.first_name.value,
            lastName: form.last_name.value,
            address: form.address.value,
            city: form.city.value,
            country: form.country.value,
            zip: form.zip.value,
            email: form.email.value,
            phone: form.phone.value,
        };

        const cart_list = JSON.parse(localStorage.getItem('cart_list') ?? '[]');
        let productLines = cart_list.map((item, index) => {
                return `ðŸ›’ ${index + 1}. ${item.title} x${item.qty} = $${(item.qty * item.price).toFixed(2)}\nðŸ–¼ï¸ ${item.image}`;
            }).join('\n\n');

        // Calculate total USD and KHR
        let totalUSD = cart_list.reduce((sum, item) => sum + (item.qty * item.price), 0);
        let totalKHR = totalUSD * 4100;

        // Update DOM total labels
        document.getElementById("label_total_usd").textContent = `$${totalUSD.toFixed(2)}`;
        document.getElementById("label_total_khr").textContent = `áŸ›${totalKHR.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

        // Final message to Telegram
        const message = `
            =======ðŸ“¦ New Checkout Order=======
            ðŸ‘¤ Name: ${data.firstName} ${data.lastName}
            ðŸ  Address: ${data.address}, ${data.city}, ${data.country} ${data.zip}
            ðŸ“§ Email: ${data.email}
            ðŸ“± Phone: ${data.phone}

             ---------- ðŸ“¦ Order Summary ----------
            ${productLines}

            ðŸ’µ Total: $${totalUSD.toFixed(2)}
            ðŸ‡°ðŸ‡­ Total in KHR: áŸ›${totalKHR.toLocaleString('en-US', { minimumFractionDigits: 2 })}
                `;

        const botToken = "8282363808:AAGT0lAZyrs8Q5gTUDY2hgpfBDc_4KfepIk";
        const chatId = "@khchelrien2024";

        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
            }),
        })
        .then(response => response.json())
        .then(data => {
            {#alert("Order sent to Telegram!");#}
            form.reset();
            localStorage.removeItem('cart_list');

            // Reset displayed totals
            document.getElementById("label_total_usd").textContent = "$0.00";
            document.getElementById("label_total_khr").textContent = "áŸ›0.00";
        })
        .catch(error => {
            alert("Error sending message.");
            console.error("Telegram Error:", error);
        });
    });
</script>


<script>

    let cart_list = JSON.parse(localStorage.getItem('cart_list') ?? '[]');
    let cart_list_tbody = document.getElementById('cart_list_tbody');
    let label_total_usd = document.getElementById('label_total_usd');
    let label_total_khr = document.getElementById('label_total_khr');
    let cart = document.getElementById('cart')
    cart.innerText = `Cart(${cart_list.length})`
    function renderCartSummary() {
        cart_list_tbody.innerHTML = '';
        let totalUSD = 0;
        cart_list.forEach(item => {
            let itemTotal = item.qty * item.price;
            totalUSD += itemTotal;
            cart_list_tbody.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item.title}
                    <span>x${item.qty}</span>
                    <span>$${itemTotal.toFixed(2)}</span>
                </li>
            `;
        });

        label_total_usd.textContent = `$${totalUSD.toFixed(2)}`;
        label_total_khr.textContent = `áŸ›${(totalUSD * 4100).toFixed(2)}`;
    }
    renderCartSummary();
</script>
{% endblock %}
